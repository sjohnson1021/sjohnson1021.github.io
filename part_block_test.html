<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Type07 Parser Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .file-input {
        margin: 20px 0;
        padding: 10px;
        border: 2px dashed #ccc;
        border-radius: 5px;
        text-align: center;
      }
      .output {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
      .error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .success {
        border-left-color: #28a745;
        background: #d4edda;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Type07 Parser Test</h1>

      <div class="info">
        <h3>About Type07 Parser</h3>
        <p>
          This test demonstrates the new PartDataParser that implements the
          ImHex pattern structure for parsing decrypted type07 data blocks.
        </p>
        <p>The parser handles:</p>
        <ul>
          <li>
            <strong>Header structure</strong> - Part size, coordinates,
            visibility, and group name
          </li>
          <li>
            <strong>Sub-blocks</strong> - Arc (0x01), Line Segment (0x05),
            Labels (0x06), and Pins (0x09)
          </li>
          <li>
            <strong>Pin sub-types</strong> - Net information (0x00) and unknown
            types (0x01, 0x02, 0x03)
          </li>
        </ul>
      </div>

      <div class="file-input">
        <input type="file" id="fileInput" accept=".pcb,.json" />
        <p>Select a PCB file to test the PartDataParser</p>
      </div>

      <div>
        <button onclick="testWithSampleData()">Test with Sample Data</button>
        <button onclick="testWithCustomData()">Test with Custom Data</button>
        <button onclick="clearOutput()">Clear Output</button>
      </div>

      <div style="margin: 20px 0">
        <h4>Custom Hex Data Input:</h4>
        <textarea
          id="hexDataInput"
          rows="4"
          cols="80"
          placeholder="Paste hex data here (space-separated bytes)..."
          style="font-family: monospace; font-size: 12px; padding: 10px"
        >
7E 01 00 00 01 00 00 00 59 CF 0A 21 82 5D FC 1E 40 77 1B 00 01 00 06 00 00 00 43 2D 30 32 2D 32 06 22 00 00 00 11 00 00 00 BF 69 0A 21 54 2A FE 1E 60 EA 00 00 10 27 00 00 E0 32 29 00 01 00 04 00 00 00 43 31 32 30 06 1E 00 00 00 11 00 00 00 4F 58 09 21 24 79 07 1F 60 EA 00 00 10 27 00 00 E0 32 29 00 01 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 96 09 21 94 E4 F9 1E D9 07 0C 21 94 E4 F9 1E 10 27 00 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 96 09 21 94 E4 F9 1E D9 96 09 21 20 D6 FE 1E 10 27 00 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 07 0C 21 94 E4 F9 1E D9 07 0C 21 20 D6 FE 1E 10 27 00 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 96 09 21 20 D6 FE 1E D9 07 0C 21 20 D6 FE 1E 10 27 00 00 00 00 00 00 09 45 00 00 00 01 00 00 00 59 CF 0A 21 B0 C4 FD 1E 00 00 00 00 40 77 1B 00 01 00 00 00 31 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 00 00 00 00 00 78 03 00 00 00 00 00 00 00 00 00 00 09 45 00 00 00 01 00 00 00 59 CF 0A 21 04 F6 FA 1E 00 00 00 00 40 77 1B 00 01 00 00 00 32 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 00 00 00 00 00 F0 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</textarea
        >
      </div>

      <div id="output" class="output">
        <p>Output will appear here...</p>
      </div>
    </div>

    <!-- Include CryptoJS for DES decryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Include the parsers -->
    <script src="part_data_parser.js"></script>
    <script src="raw_parser.js"></script>

    <script>
      const outputDiv = document.getElementById("output");
      const fileInput = document.getElementById("fileInput");

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        logEntry.className = type;
        outputDiv.appendChild(logEntry);
        console.log(message);
      }

      function clearOutput() {
        outputDiv.innerHTML = "<p>Output cleared...</p>";
      }

      function testWithSampleData() {
        log("Testing PartDataParser with sample data...", "info");

        // Create sample decrypted data that matches the ImHex pattern
        const sampleData = createSampleType07Data();

        try {
          const partDataParser = new PartDataParser();
          const result = partDataParser.parse(sampleData.buffer);

          log("PartDataParser test successful!", "success");
          log("Parsed structure:", "info");
          log("<pre>" + JSON.stringify(result, null, 2) + "</pre>", "info");
        } catch (error) {
          log("PartDataParser test failed: " + error.message, "error");
          console.error(error);
        }
      }

      function testWithCustomData() {
        log("Testing PartDataParser with custom data...", "info");

        const hexInput = document.getElementById("hexDataInput").value.trim();
        if (!hexInput) {
          log("Please enter hex data in the text area above", "error");
          return;
        }

        try {
          // Convert hex string to Uint8Array
          const hexBytes = hexInput.split(/\s+/).map((byte) => {
            const parsed = parseInt(byte, 16);
            if (isNaN(parsed)) {
              throw new Error(`Invalid hex byte: ${byte}`);
            }
            return parsed;
          });

          const dataArray = new Uint8Array(hexBytes);
          log(`Converted ${dataArray.length} bytes from hex input`, "info");

          const partDataParser = new PartDataParser();
          const result = partDataParser.parse(dataArray.buffer);

          log("PartDataParser test successful!", "success");
          log("Parsed structure:", "info");
          log("<pre>" + JSON.stringify(result, null, 2) + "</pre>", "info");
        } catch (error) {
          log("PartDataParser test failed: " + error.message, "error");
          console.error(error);
        }
      }

      function createSampleType07Data() {
        // Use the provided real hex data
        const hexString =
          "7E 01 00 00 01 00 00 00 59 CF 0A 21 82 5D FC 1E 40 77 1B 00 01 00 06 00 00 00 43 2D 30 32 2D 32 06 22 00 00 00 11 00 00 00 BF 69 0A 21 54 2A FE 1E 60 EA 00 00 10 27 00 00 E0 32 29 00 01 00 04 00 00 00 43 31 32 30 06 1E 00 00 00 11 00 00 00 4F 58 09 21 24 79 07 1F 60 EA 00 00 10 27 00 00 E0 32 29 00 01 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 96 09 21 94 E4 F9 1E D9 07 0C 21 94 E4 F9 1E 10 27 00 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 96 09 21 94 E4 F9 1E D9 96 09 21 20 D6 FE 1E 10 27 00 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 07 0C 21 94 E4 F9 1E D9 07 0C 21 20 D6 FE 1E 10 27 00 00 00 00 00 00 05 1C 00 00 00 11 00 00 00 D9 96 09 21 20 D6 FE 1E D9 07 0C 21 20 D6 FE 1E 10 27 00 00 00 00 00 00 09 45 00 00 00 01 00 00 00 59 CF 0A 21 B0 C4 FD 1E 00 00 00 00 40 77 1B 00 01 00 00 00 31 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 00 00 00 00 00 78 03 00 00 00 00 00 00 00 00 00 00 09 45 00 00 00 01 00 00 00 59 CF 0A 21 04 F6 FA 1E 00 00 00 00 40 77 1B 00 01 00 00 00 32 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 C0 D4 01 00 A0 86 01 00 02 00 00 00 00 00 F0 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00";

        // Convert hex string to Uint8Array
        const hexBytes = hexString.split(" ").map((byte) => parseInt(byte, 16));
        const dataArray = new Uint8Array(hexBytes);

        return dataArray;
      }

      fileInput.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        log(`Processing file: ${file.name}`, "info");

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const arrayBuffer = e.target.result;
            const rawParser = new RawPCBParser();
            const result = rawParser.parse(arrayBuffer);

            log("File parsed successfully!", "success");

            // Look for type07 blocks
            const type07Blocks = result.main_data_block.filter(
              (block) => block.DATA
            );
            if (type07Blocks.length > 0) {
              log(`Found ${type07Blocks.length} type07 blocks`, "info");

              type07Blocks.forEach((block, index) => {
                if (block.DATA.parsed_data) {
                  log(`Type07 Block ${index + 1} parsed data:`, "info");
                  log(
                    "<pre>" +
                      JSON.stringify(block.DATA.parsed_data, null, 2) +
                      "</pre>",
                    "info"
                  );
                } else {
                  log(
                    `Type07 Block ${
                      index + 1
                    } has no parsed data (decryption may have failed)`,
                    "error"
                  );
                }
              });
            } else {
              log("No type07 blocks found in the file", "info");
            }
          } catch (error) {
            log("Error processing file: " + error.message, "error");
            console.error(error);
          }
        };

        reader.readAsArrayBuffer(file);
      });
    </script>
  </body>
</html>
